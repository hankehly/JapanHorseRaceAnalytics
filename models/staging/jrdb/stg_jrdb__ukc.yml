sources:
  - name: jrdb
    schema: jhra_raw
    tables:
      - name: raw_jrdb__ukc

models:
  - name: stg_jrdb__ukc
    description: |
      There are a handful (<20) of duplicate rows in the source data.
      All of them are exact duplicates within the same file, so we can safely pick one.
      This staging table removes those duplicates.

      There are a handful (<10) records where データ年月日 = '99999999'
      The meanning of this value is unclear, but I'm guessing it indicates some kind of missing or unknown date.
      These records are all removed in this staging table.

    columns:
      - name: ukc_sk
        data_tests:
          - unique
          - not_null

      - name: 血統登録番号
        quote: true
        data_tests:
          - not_null

      - name: 馬名
        quote: true
        data_tests:
          - not_null

      - name: 性別コード
        quote: true
        data_tests:
          - not_null
          - accepted_values:
              values: ['1', '2', '3']

      - name: 毛色コード
        quote: true
        data_tests:
          - not_null
          - relationships:
              arguments:
                to: ref('jrdb__hair_color_codes')
                field: code

      - name: 馬記号コード
        quote: true
        description: |
          Nulls are replaced with '00' because that indicates unknown 馬記号コード.
          There are only 3 or so nulls in the data until 2023, so very rare.
        data_tests:
          - not_null
          - relationships:
              arguments:
                to: ref('jrdb__horse_symbol_codes')
                field: code

      - name: 血統情報_父馬名
        quote: true
        data_tests:
          - not_null

      - name: 血統情報_母馬名
        quote: true
        description: There are a small number of records (~10) with null 母馬名.

      - name: 血統情報_母父馬名
        quote: true
        data_tests:
          - not_null

      - name: 生年月日
        quote: true
        data_tests:
          - not_null

      - name: 父馬生年
        quote: true
        description: |
          YYYY 血統キー用
          There are only a few records with null 父馬生年.

      - name: 母馬生年
        quote: true
        description: |
          YYYY 血統キー用
          There are only a few records with null 母馬生年, and they include the records where 父馬生年 is null.

      - name: 母父馬生年
        quote: true
        description: |
          YYYY 血統キー用
          There are only 2 or so records with null 母父馬生年.

      - name: 馬主名
        quote: true
        description: Only 8 or so records with null 馬主名.

      - name: 馬主会コード
        quote: true
        description: |
          競馬場毎にある。場コードと同じ。
          参考データです。設定されていないデータが有ります。
        data_tests:
          - relationships:
              arguments:
                to: ref('jrdb__horse_owner_association_codes')
                field: code

      - name: 生産者名
        quote: true
        description: Only 6 or so records with null 生産者名.

      - name: 産地名
        quote: true
        description: Only about 3 nulls in the data.

      - name: 登録抹消フラグ
        quote: true
        data_tests:
          - not_null
          - accepted_values:
              values: [ 0, 1 ]

      - name: データ年月日
        quote: true
        data_tests:
          - not_null

      - name: 父系統コード
        quote: true
        description: |
          Only about 10 nulls in the data.
          前２桁：血統を１２系統に分けた大系統コードです。
          後２桁：小系統コードです。
        data_tests:
          - relationships:
              arguments:
                to: ref('jrdb__lineage_codes')
                field: code
      
      - name: 父大系統コード
        quote: true
        description: Only about 10 nulls in the data.

      - name: 母父系統コード
        quote: true
        description: |
          Only about 4 nulls in the data.
          前２桁：血統を１２系統に分けた大系統コードです。
          後２桁：小系統コードです。
        data_tests:
          - relationships:
              arguments:
                to: ref('jrdb__lineage_codes')
                field: code
      
      - name: 母父大系統コード
        quote: true
        description: Only about 4 nulls in the data.

      - name: _file_name
        data_tests:
          - not_null

      - name: _sha256
        data_tests:
          - not_null

  - name: stg_jrdb__ukc_latest
    description: |
      最新の血統データのみを保持するテーブル
      There is no information in the UKC table that would require keeping historical records.
      Therefore, this table keeps only the latest record for each horse.
